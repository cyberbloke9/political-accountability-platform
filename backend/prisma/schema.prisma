// Political Accountability Platform - Prisma Schema (Supabase Migration)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CitizenTitle {
  Citizen
  Watchdog
  Guardian
  Champion
  Sentinel
}

enum PromiseStatus {
  pending
  in_progress
  fulfilled
  broken
  disputed
}

enum VerificationStatus {
  pending
  approved
  rejected
  disputed
}

enum CompletionStatus {
  not_started
  partial
  completed
  exceeded
}

enum TimelineStatus {
  early
  on_time
  delayed
  very_delayed
}

enum BudgetStatus {
  under_budget
  on_budget
  over_budget
  unknown
}

enum VoteType {
  approve
  reject
}

enum EvidenceFileType {
  image
  video
}

model User {
  id             String        @id @default(uuid()) @db.Uuid
  authId         String?       @unique @map("auth_id") @db.Uuid
  email          String        @unique @db.VarChar(255)
  username       String        @unique @db.VarChar(50)
  citizenScore   Int           @default(0) @map("citizen_score")
  citizenTitle   CitizenTitle  @default(Citizen) @map("citizen_title")
  reputation     Decimal       @default(1.0) @db.Decimal(5, 2)
  isVerified     Boolean       @default(false) @map("is_verified")
  preferences    Json          @default("{}") @db.JsonB
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  promises       Promise[]
  verifications  Verification[]
  votes          Vote[]
  activityLogs   ActivityLog[]

  @@index([email])
  @@index([authId])
  @@index([citizenScore(sort: Desc)])
  @@map("users")
}

model Promise {
  id                    String          @id @default(uuid()) @db.Uuid
  title                 String          @db.VarChar(200)
  description           String          @db.Text
  category              String          @db.VarChar(100)
  leaderName            String          @map("leader_name") @db.VarChar(100)
  leaderParty           String          @map("leader_party") @db.VarChar(100)
  constituency          String?         @db.VarChar(100)
  promisedDate          DateTime        @map("promised_date") @db.Date
  targetCompletionDate  DateTime?       @map("target_completion_date") @db.Date
  location              String          @db.VarChar(150)
  status                PromiseStatus   @default(pending)
  createdBy             String          @map("created_by") @db.Uuid
  metadata              Json            @default("{}") @db.JsonB
  createdAt             DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  creator               User            @relation(fields: [createdBy], references: [id])
  verifications         Verification[]

  @@index([createdBy])
  @@index([status])
  @@map("promises")
}

model Verification {
  id                    String              @id @default(uuid()) @db.Uuid
  promiseId             String              @map("promise_id") @db.Uuid
  submittedBy           String              @map("submitted_by") @db.Uuid
  completionStatus      CompletionStatus    @map("completion_status")
  qualityRating         Int?                @map("quality_rating")
  timelineStatus        TimelineStatus      @map("timeline_status")
  budgetStatus          BudgetStatus        @default(unknown) @map("budget_status")
  impactRating          Int?                @map("impact_rating")
  description           String              @db.Text
  verificationStatus    VerificationStatus  @default(pending) @map("verification_status")
  communityVotesFor     Int                 @default(0) @map("community_votes_for")
  communityVotesAgainst Int                 @default(0) @map("community_votes_against")
  expertReviewed        Boolean             @default(false) @map("expert_reviewed")
  evidenceMetadata      Json                @default("{}") @map("evidence_metadata") @db.JsonB
  fraudFlags            String[]            @default([]) @map("fraud_flags")
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  promise               Promise             @relation(fields: [promiseId], references: [id], onDelete: Cascade)
  submitter             User                @relation(fields: [submittedBy], references: [id])
  votes                 Vote[]
  evidenceFiles         EvidenceFile[]

  @@index([promiseId])
  @@index([verificationStatus])
  @@map("verifications")
}

model Vote {
  id              String      @id @default(uuid()) @db.Uuid
  verificationId  String      @map("verification_id") @db.Uuid
  userId          String      @map("user_id") @db.Uuid
  voteType        VoteType    @map("vote_type")
  weight          Decimal     @default(1.0) @db.Decimal(3, 1)
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz

  verification    Verification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id])

  @@unique([verificationId, userId])
  @@index([verificationId])
  @@map("votes")
}

model EvidenceFile {
  id              String           @id @default(uuid()) @db.Uuid
  verificationId  String           @map("verification_id") @db.Uuid
  fileType        EvidenceFileType @map("file_type")
  storageUrl      String           @map("storage_url") @db.VarChar(500)
  fileSizeBytes   Int              @map("file_size_bytes")
  thumbnailUrl    String?          @map("thumbnail_url") @db.VarChar(500)
  metadata        Json             @default("{}") @db.JsonB
  uploadedAt      DateTime         @default(now()) @map("uploaded_at") @db.Timestamptz

  verification    Verification     @relation(fields: [verificationId], references: [id], onDelete: Cascade)

  @@index([verificationId])
  @@map("evidence_files")
}

model ActivityLog {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String?   @map("user_id") @db.Uuid
  actionType  String    @map("action_type") @db.VarChar(100)
  metadata    Json      @default("{}") @db.JsonB
  ipAddress   String?   @map("ip_address") @db.VarChar(45)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("activity_logs")
}
